<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Perspective Platform</title>
  <style>
    body { text-align: center; font-family: Arial, sans-serif; }
    canvas { background: lightgray; margin-top: 10px; display: block; margin: auto; }
  </style>
</head>
<body>
  <h1>3D Perspective Platform</h1>
  <canvas id="canvas"></canvas>
  <p>Use arrow keys to move</p>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = 500;
    canvas.height = 500;

    let player = { x: 0, y: 10, z: -30 }; // Player's position
    const nearClip = 0.1; // Lowered clipping plane for smoother behavior

    const platform = [
      { x: -20, y: 0, z: -20 },
      { x: 20, y: 0, z: -20 },
      { x: 20, y: 0, z: 20 },
      { x: -20, y: 0, z: 20 }
    ];

    // Projects a 3D point to 2D canvas coordinates.
    function project(point) {
      let relativeZ = point.z - player.z;
      if (relativeZ < nearClip) relativeZ = nearClip; // Clamp to avoid division errors

      let scale = 200 / (relativeZ + 100);
      return {
        x: canvas.width / 2 + (point.x - player.x) * scale,
        y: canvas.height / 2 - (point.y - player.y) * scale
      };
    }

    // Clips a line between p1 and p2 against the near clipping plane.
    function clipLine(p1, p2) {
      let z1 = p1.z - player.z;
      let z2 = p2.z - player.z;

      if (z1 >= nearClip && z2 >= nearClip) return [p1, p2]; // Both visible
      if (z1 < nearClip && z2 < nearClip) return null;         // Both behind, ignore

      // Compute interpolation factor t where the line intersects the near clipping plane.
      let t = (nearClip - z1) / (z2 - z1);
      let clippedPoint = {
        x: p1.x + t * (p2.x - p1.x),
        y: p1.y + t * (p2.y - p1.y),
        z: player.z + nearClip
      };

      return z1 < nearClip ? [clippedPoint, p2] : [p1, clippedPoint];
    }

    function drawPlatform() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let i = 0; i < platform.length; i++) {
        let p1 = platform[i];
        let p2 = platform[(i + 1) % platform.length];

        let clipped = clipLine(p1, p2);
        if (!clipped) continue;

        let proj1 = project(clipped[0]);
        let proj2 = project(clipped[1]);

        ctx.beginPath();
        ctx.moveTo(proj1.x, proj1.y);
        ctx.lineTo(proj2.x, proj2.y);
        ctx.strokeStyle = "black";
        ctx.lineWidth = 2;
        ctx.stroke();
      }
    }

    function update() {
      drawPlatform();
      requestAnimationFrame(update);
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowUp") player.z += 2;
      if (e.key === "ArrowDown") player.z -= 2;
      if (e.key === "ArrowLeft") player.x -= 2;
      if (e.key === "ArrowRight") player.x += 2;
    });

    update();
  </script>
</body>
</html>
