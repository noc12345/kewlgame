<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Perspective Platform</title>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        canvas { background: lightgray; margin-top: 10px; display: block; margin: auto; }
    </style>
</head>
<body>
    <h1>3D Perspective Platform</h1>
    <canvas id="canvas"></canvas>
    <p>Use arrow keys to move</p>

    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");

        canvas.width = 500;
        canvas.height = 500;

        // Player and camera are at the same position
        let player = { x: 0, y: 10, z: 0 };
        const nearClip = 1; // Clipping plane distance
        const clippingThreshold = -20; // Distance (in studs) after which clipping starts

        const platform = [
            { x: -30, y: 0, z: -30 },
            { x: 30, y: 0, z: -30 },
            { x: 30, y: 0, z: 30 },
            { x: -30, y: 0, z: 30 }
        ];

        // Calculate the distance from the player to a point
        function distance(p1, p2) {
            return Math.sqrt((p1.x - p2.x) ** 2 + (p1.y - p2.y) ** 2 + (p1.z - p2.z) ** 2);
        }

        // Perspective projection function
        function project(point) {
            let relativeZ = point.z - player.z;
            if (relativeZ <= 0) return null; // Skip points behind the camera
            
            // Perspective scaling
            let scale = 200 / (relativeZ + 100);
            return {
                x: canvas.width / 2 + (point.x - player.x) * scale,
                y: canvas.height / 2 - (point.y - player.y) * scale
            };
        }

        // Line clipping function with delayed start
        function clipLine(p1, p2) {
            let z1 = p1.z - player.z;
            let z2 = p2.z - player.z;

            // Skip lines that are both behind the camera
            if (z1 < nearClip && z2 < nearClip) return null;

            // Calculate the distance from the player to each platform point
            const dist1 = distance(player, p1);
            const dist2 = distance(player, p2);

            // Only start clipping if the distance to the point is greater than the threshold
            if (dist1 < clippingThreshold && dist2 < clippingThreshold) return [p1, p2];

            // If one point is behind, clip the line to the near plane
            if (z1 >= nearClip && z2 >= nearClip) return [p1, p2];

            let t = (nearClip - z1) / (z2 - z1); // Calculate where it intersects the near clip plane
            let clippedPoint = {
                x: p1.x + t * (p2.x - p1.x),
                y: p1.y + t * (p2.y - p1.y),
                z: player.z + nearClip
            };

            return z1 < nearClip ? [clippedPoint, p2] : [p1, clippedPoint];
        }

        // Drawing function for platform
        function drawPlatform() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let i = 0; i < platform.length; i++) {
                let p1 = platform[i];
                let p2 = platform[(i + 1) % platform.length];

                let clipped = clipLine(p1, p2);
                if (!clipped) continue;

                let proj1 = project(clipped[0]);
                let proj2 = project(clipped[1]);

                if (proj1 && proj2) { // Ensure the points are in the visible area
                    ctx.beginPath();
                    ctx.moveTo(proj1.x, proj1.y);
                    ctx.lineTo(proj2.x, proj2.y);
                    ctx.strokeStyle = "black";
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
        }

        // Game loop for continuous updating
        function update() {
            drawPlatform();
            requestAnimationFrame(update);
        }

        // Player movement controls
        document.addEventListener("keydown", (e) => {
            if (e.key === "ArrowUp") player.z += 2;
            if (e.key === "ArrowDown") player.z -= 2;
            if (e.key === "ArrowLeft") player.x -= 2;
            if (e.key === "ArrowRight") player.x += 2;
        });

        // Start the game loop
        update();
    </script>
</body>
</html>
